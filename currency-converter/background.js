(()=>{"use strict";const e=new class{async getRates(e){try{const t=await this.getCached(e);if(t&&this.isCacheValid(t))return{rates:t.rates,base:t.base,timestamp:t.timestamp,cached:!0};const a=await this.fetchFromAPI(e);return await this.updateCache(a),{rates:a.rates,base:a.base,timestamp:a.timestamp,cached:!1}}catch(t){console.error("Failed to get rates:",t);const a=await this.getCached(e);if(a)return console.warn("Using stale cache due to API error"),{rates:a.rates,base:a.base,timestamp:a.timestamp,cached:!0};throw t}}async fetchFromAPI(e){const t=`https://v6.exchangerate-api.com/v6/63b85a6ebcfdfb4181267653/latest/${e}`,a=await fetch(t);if(!a.ok)throw new Error(`API error: ${a.status}`);const s=await a.json();return{rates:s.conversion_rates,base:s.base_code,timestamp:Date.now(),source:"exchangerate-api"}}async getCached(e){try{const t=`rateCache_${e}`;return(await chrome.storage.local.get(t))[t]||null}catch(e){return console.error("Failed to get cached rates:",e),null}}async updateCache(e){try{const t=`rateCache_${e.base}`;await chrome.storage.local.set({[t]:e})}catch(e){console.error("Failed to update cache:",e)}}isCacheValid(e){return Date.now()-e.timestamp<36e5}},t={enabled:!0,baseCurrency:"CNY",displayFormat:"inline",decimalPlaces:2,showOriginalCurrency:!0,showExchangeRate:!0,language:"zh",enabledSites:[],disabledSites:[],useWhitelist:!1,autoUpdate:!0,updateInterval:60,maxElementsToScan:1e3,debounceDelay:300},a=new class{async loadSettings(){try{return(await chrome.storage.local.get("settings")).settings||t}catch(e){return console.error("Failed to load settings:",e),t}}async saveSettings(e){try{await chrome.storage.local.set({settings:e})}catch(e){throw console.error("Failed to save settings:",e),e}}async clearCache(){try{const e=await chrome.storage.local.get(null),t=Object.keys(e).filter(e=>e.startsWith("rateCache_"));t.length>0&&await chrome.storage.local.remove(t)}catch(e){throw console.error("Failed to clear cache:",e),e}}};console.log("Currency Converter Extension: Service Worker loaded"),chrome.runtime.onInstalled.addListener(async e=>{console.log("Extension installed/updated:",e.reason);const t=await chrome.tabs.query({});for(const e of t)if(e.id)try{await chrome.tabs.sendMessage(e.id,{type:"EXTENSION_RELOADED"})}catch(e){}}),chrome.action.onClicked.addListener(e=>{chrome.sidePanel.open({windowId:e.windowId})}),chrome.runtime.onMessage.addListener((t,s,r)=>(async function(t){switch(t.type){case"GET_RATES":{const{baseCurrency:a}=t.payload;return await e.getRates(a)}case"UPDATE_SETTINGS":{const{settings:e}=t.payload;return await a.saveSettings(e),{success:!0}}case"CLEAR_CACHE":return await a.clearCache(),{success:!0};default:throw new Error(`Unknown message type: ${t.type}`)}}(t).then(r).catch(e=>{console.error("Message handler error:",e),r({error:e.message})}),!0))})();