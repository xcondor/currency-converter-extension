(()=>{"use strict";const e=new class{async getRates(e){try{console.log(`Getting rates for ${e}...`);const t=await this.getCached(e);if(t&&this.isCacheValid(t))return console.log(`✓ Using cached rates (age: ${Math.round((Date.now()-t.timestamp)/1e3/60)}min)`),{rates:t.rates,base:t.base,timestamp:t.timestamp,cached:!0};console.log("Cache miss or expired, fetching from API...");const a=await this.fetchFromAPI(e);return await this.updateCache(a),{rates:a.rates,base:a.base,timestamp:a.timestamp,cached:!1}}catch(t){console.error("Failed to get rates:",t);const a=await this.getCached(e);if(a)return console.warn(`⚠️ Using stale cache (age: ${Math.round((Date.now()-a.timestamp)/1e3/60)}min) due to API error`),{rates:a.rates,base:a.base,timestamp:a.timestamp,cached:!0};throw new Error(`无法获取汇率数据：${t instanceof Error?t.message:"未知错误"}。请检查网络连接。`)}}async fetchFromAPI(e){const t=`https://v6.exchangerate-api.com/v6/63b85a6ebcfdfb4181267653/latest/${e}`;for(let a=0;a<=2;a++)try{console.log(`Fetching rates from API (attempt ${a+1}/3)...`);const o=new AbortController,s=setTimeout(()=>o.abort(),1e4),r=await fetch(t,{signal:o.signal,headers:{Accept:"application/json"}});if(clearTimeout(s),!r.ok)throw new Error(`API error: ${r.status} ${r.statusText}`);const n=await r.json();if(!n.conversion_rates||!n.base_code)throw new Error("Invalid API response format");return console.log(`✓ Successfully fetched rates for ${e}`),{rates:n.conversion_rates,base:n.base_code,timestamp:Date.now(),source:"exchangerate-api"}}catch(e){const t=2===a;if(e instanceof Error&&("AbortError"===e.name?console.warn(`Request timeout (attempt ${a+1})`):console.warn(`API request failed (attempt ${a+1}):`,e.message)),t)throw new Error(`Failed to fetch rates after 3 attempts: ${e instanceof Error?e.message:"Unknown error"}`);const o=Math.min(1e3*Math.pow(2,a),5e3);console.log(`Retrying in ${o}ms...`),await new Promise(e=>setTimeout(e,o))}throw new Error("Failed to fetch rates")}async getCached(e){try{const t=`rateCache_${e}`;return(await chrome.storage.local.get(t))[t]||null}catch(e){return console.error("Failed to get cached rates:",e),null}}async updateCache(e){try{const t=`rateCache_${e.base}`;await chrome.storage.local.set({[t]:e})}catch(e){console.error("Failed to update cache:",e)}}isCacheValid(e){return Date.now()-e.timestamp<36e5}},t={enabled:!0,baseCurrency:"CNY",displayFormat:"inline",decimalPlaces:2,showOriginalCurrency:!0,showExchangeRate:!0,language:"zh",enabledSites:[],disabledSites:[],useWhitelist:!1,autoUpdate:!0,updateInterval:60,maxElementsToScan:1e3,debounceDelay:300},a=new class{async loadSettings(){try{return(await chrome.storage.local.get("settings")).settings||t}catch(e){return console.error("Failed to load settings:",e),t}}async saveSettings(e){try{await chrome.storage.local.set({settings:e})}catch(e){throw console.error("Failed to save settings:",e),e}}async clearCache(){try{const e=await chrome.storage.local.get(null),t=Object.keys(e).filter(e=>e.startsWith("rateCache_"));t.length>0&&await chrome.storage.local.remove(t)}catch(e){throw console.error("Failed to clear cache:",e),e}}};console.log("Currency Converter Extension: Service Worker loaded"),chrome.runtime.onInstalled.addListener(async e=>{console.log("Extension installed/updated:",e.reason);const t=await chrome.tabs.query({});for(const e of t)if(e.id)try{await chrome.tabs.sendMessage(e.id,{type:"EXTENSION_RELOADED"})}catch(e){}}),chrome.action.onClicked.addListener(async e=>{try{if(console.log("Action clicked, opening side panel for tab:",e.id),!e.windowId)return void console.error("No windowId available");await chrome.sidePanel.open({windowId:e.windowId}),console.log("Side panel opened successfully")}catch(t){console.error("Failed to open side panel:",t);try{await chrome.sidePanel.setOptions({tabId:e.id,path:"popup.html",enabled:!0}),await chrome.sidePanel.open({windowId:e.windowId}),console.log("Side panel opened using fallback method")}catch(e){console.error("Fallback method also failed:",e)}}}),chrome.runtime.onMessage.addListener((t,o,s)=>(async function(t){switch(t.type){case"GET_RATES":{const{baseCurrency:a}=t.payload;return await e.getRates(a)}case"UPDATE_SETTINGS":{const{settings:e}=t.payload;return await a.saveSettings(e),{success:!0}}case"CLEAR_CACHE":return await a.clearCache(),{success:!0};default:throw new Error(`Unknown message type: ${t.type}`)}}(t).then(s).catch(e=>{console.error("Message handler error:",e),s({error:e.message})}),!0))})();