(()=>{"use strict";const e=["USD","EUR","GBP","JPY","CNY","CAD","AUD","CHF","HKD","SGD","KRW","INR","RUB","BRL","MXN","ZAR"],n={$:"USD","‚Ç¨":"EUR","¬£":"GBP","¬•":"JPY","Ôø•":"CNY","‚Çπ":"INR","‚ÇΩ":"RUB","‚Ç©":"KRW",C$:"CAD",A$:"AUD",HK$:"HKD",S$:"SGD",R$:"BRL",R:"ZAR"},t=/(?<![A-Z])([¬•Ôø•$‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]|C\$|A\$|HK\$|S\$|R\$|R)\s*(\d+(?:[,\s]\d{3})*(?:\.\d+)?)/gi,a=/(?:^|[^\d])(\d+(?:[,\s]\d{3})*(?:\.\d+)?)\s+(USD|EUR|GBP|JPY|CNY|CAD|AUD|CHF|HKD|SGD|KRW|INR|RUB|BRL|MXN|ZAR|RMB)\b/gi,o=/\b(USD|EUR|GBP|JPY|CNY|CAD|AUD|CHF|HKD|SGD|KRW|INR|RUB|BRL|MXN|ZAR|RMB)\s+(\d+(?:[,\s]\d{3})*(?:\.\d+)?)/gi,r=/(¬•|Ôø•)?\s*(\d+(?:[,\s]\d{3})*(?:\.\d+)?)\s*(ÂÖÉ|‰∫∫Ê∞ëÂ∏Å|RMB)?/g;function s(t){const a=t.trim().toUpperCase();if("RMB"===a)return"CNY";if("ÂÖÉ"===a||"‰∫∫Ê∞ëÂ∏Å"===a)return"CNY";return n[t]||(e.includes(a)?a:"")}function i(e){const n=e.replace(/[\s,]/g,""),t=parseFloat(n);return isNaN(t)||!isFinite(t)||t<0?0:t}function c(e,n,t=2){const a=Math.max(2,t),o=e.toFixed(a).split(".");return o[0]=o[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),`${o.join(".")} ${n}`}const l={zh:{appName:"Ê±áÁéáËΩ¨Êç¢Âô®",appSubtitle:"ÂÆûÊó∂Ë¥ßÂ∏ÅËΩ¨Êç¢Âä©Êâã",controlTitle:"ÂäüËÉΩÊéßÂà∂",autoConvertLabel:"Ëá™Âä®ËΩ¨Êç¢",autoConvertDesc:"ÂºÄÂêØÂêéËá™Âä®ËØÜÂà´Âπ∂ËΩ¨Êç¢È°µÈù¢Ë¥ßÂ∏Å",settingsTitle:"ËΩ¨Êç¢ËÆæÁΩÆ",baseCurrencyLabel:"Êú¨Âú∞Ë¥ßÂ∏Å",decimalPlacesLabel:"Â∞èÊï∞‰ΩçÊï∞",showRateLabel:"ÊÇ¨ÂÅúÊó∂ÊòæÁ§∫Ê±áÁéá‰ø°ÊÅØ",currencyCNY:"üá®üá≥ ‰∫∫Ê∞ëÂ∏Å (CNY)",currencyUSD:"üá∫üá∏ ÁæéÂÖÉ (USD)",currencyEUR:"üá™üá∫ Ê¨ßÂÖÉ (EUR)",currencyGBP:"üá¨üáß Ëã±Èïë (GBP)",currencyJPY:"üáØüáµ Êó•ÂÖÉ (JPY)",currencyKRW:"üá∞üá∑ Èü©ÂÖÉ (KRW)",currencyHKD:"üá≠üá∞ Ê∏ØÂ∏Å (HKD)",statusTitle:"Ê±áÁéáÁä∂ÊÄÅ",statusLoading:"Âä†ËΩΩ‰∏≠...",statusLatest:"Ê±áÁéáÁä∂ÊÄÅ: ÊúÄÊñ∞",statusExpired:"Ê±áÁéáÁä∂ÊÄÅ: Â∑≤ËøáÊúü",statusNotCached:"Ê±áÁéáÁä∂ÊÄÅ: Êú™ÁºìÂ≠ò",statusFailed:"Ê±áÁéáÁä∂ÊÄÅ: Âä†ËΩΩÂ§±Ë¥•",statusDesc:"Ê±áÁéáÊï∞ÊçÆÊØèÂ∞èÊó∂Êõ¥Êñ∞",clearCacheBtn:"Ê∏ÖÈô§ÁºìÂ≠ò",settingsSaved:"ËÆæÁΩÆÂ∑≤Ëá™Âä®‰øùÂ≠ò",settingsSaveFailed:"‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•",cacheCleared:"ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§",cacheClearFailed:"Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•",settingsLoadFailed:"Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•",convertedCount:"Â∑≤ËΩ¨Êç¢",conversionDisabled:"Ëá™Âä®ËΩ¨Êç¢Â∑≤Á¶ÅÁî®",fetchingRates:"Ê≠£Âú®Ëé∑ÂèñÊ±áÁéáÊï∞ÊçÆ...",fetchRatesFailed:"Ëé∑ÂèñÊ±áÁéáÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•",footerText:"Êï∞ÊçÆÁî± ExchangeRate-API Êèê‰æõ",rateInfo:"Ê±áÁéá",clickToConfig:"ÁÇπÂáªÊèí‰ª∂ÂõæÊ†áÂèØÈÖçÁΩÆËÆæÁΩÆ",minutesAgo:"ÂàÜÈíüÂâçÊõ¥Êñ∞",hoursAgo:"Â∞èÊó∂Ââç"},en:{appName:"Currency Converter",appSubtitle:"Real-time Currency Conversion Assistant",controlTitle:"Function Control",autoConvertLabel:"Auto Convert",autoConvertDesc:"Automatically detect and convert currencies on page",settingsTitle:"Conversion Settings",baseCurrencyLabel:"Base Currency",decimalPlacesLabel:"Decimal Places",showRateLabel:"Show exchange rate on hover",currencyCNY:"üá®üá≥ Chinese Yuan (CNY)",currencyUSD:"üá∫üá∏ US Dollar (USD)",currencyEUR:"üá™üá∫ Euro (EUR)",currencyGBP:"üá¨üáß British Pound (GBP)",currencyJPY:"üáØüáµ Japanese Yen (JPY)",currencyKRW:"üá∞üá∑ Korean Won (KRW)",currencyHKD:"üá≠üá∞ Hong Kong Dollar (HKD)",statusTitle:"Exchange Rate Status",statusLoading:"Loading...",statusLatest:"Status: Latest",statusExpired:"Status: Expired",statusNotCached:"Status: Not Cached",statusFailed:"Status: Load Failed",statusDesc:"Exchange rates update hourly",clearCacheBtn:"Clear Cache",settingsSaved:"Settings saved automatically",settingsSaveFailed:"Failed to save settings",cacheCleared:"Cache cleared",cacheClearFailed:"Failed to clear cache",settingsLoadFailed:"Failed to load settings",convertedCount:"Converted",conversionDisabled:"Auto conversion disabled",fetchingRates:"Fetching exchange rates...",fetchRatesFailed:"Failed to fetch rates, please check network",footerText:"Data provided by ExchangeRate-API",rateInfo:"Rate",clickToConfig:"Click extension icon to configure",minutesAgo:"min ago",hoursAgo:"hr ago"}},d=new class{constructor(){this.currentLanguage="zh",this.loadLanguage()}async loadLanguage(){try{const e=await chrome.storage.local.get("language");this.currentLanguage=e.language||"zh"}catch(e){console.error("Failed to load language:",e)}}async setLanguage(e){this.currentLanguage=e;try{await chrome.storage.local.set({language:e})}catch(e){console.error("Failed to save language:",e)}}getLanguage(){return this.currentLanguage}t(e){return l[this.currentLanguage][e]}getMessages(){return l[this.currentLanguage]}},u=new class{create(e,n=!1){const t=document.createElement("span");t.className="currency-converter-overlay",t.style.cssText="\n      display: inline-flex;\n      align-items: center;\n      gap: 6px;\n      margin-left: 8px;\n      padding: 6px 12px;\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      color: white;\n      border-radius: 6px;\n      font-size: 0.9em;\n      font-weight: 700;\n      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;\n      white-space: nowrap;\n      cursor: help;\n      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);\n      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);\n      letter-spacing: 0.5px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      position: relative;\n      overflow: hidden;\n    ";const a=document.createElement("span");a.textContent=e.formattedResult,a.style.cssText="\n      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);\n      font-variant-numeric: tabular-nums;\n    ";const o=document.createElement("span");if(o.style.cssText="\n      position: absolute;\n      top: -50%;\n      left: -50%;\n      width: 200%;\n      height: 200%;\n      background: linear-gradient(\n        45deg,\n        transparent 30%,\n        rgba(255, 255, 255, 0.3) 50%,\n        transparent 70%\n      );\n      transform: translateX(-100%);\n      pointer-events: none;\n    ",t.appendChild(a),t.appendChild(o),t.addEventListener("mouseenter",()=>{t.style.transform="scale(1.08) translateY(-2px)",t.style.boxShadow="0 4px 16px rgba(16, 185, 129, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.3)",o.style.animation="shine 0.6s ease"}),t.addEventListener("mouseleave",()=>{t.style.transform="scale(1) translateY(0)",t.style.boxShadow="0 2px 8px rgba(16, 185, 129, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)",o.style.animation=""}),!document.getElementById("currency-converter-shine-animation")){const e=document.createElement("style");e.id="currency-converter-shine-animation",e.textContent="\n        @keyframes shine {\n          0% {\n            transform: translateX(-100%);\n          }\n          100% {\n            transform: translateX(100%);\n          }\n        }\n      ",document.head.appendChild(e)}if(n){const n=(d.getLanguage(),`üí± ${d.t("rateInfo")}: 1 ${e.originalCurrency} = ${e.rate.toFixed(4)} ${e.targetCurrency}`);t.title=n}else t.title=d.t("clickToConfig");return t}removeAll(){document.querySelectorAll(".currency-converter-overlay").forEach(e=>e.remove());const e=document.getElementById("currency-converter-shine-animation");e&&e.remove()}},g={enabled:!0,baseCurrency:"CNY",displayFormat:"inline",decimalPlaces:2,showOriginalCurrency:!0,showExchangeRate:!0,language:"zh",enabledSites:[],disabledSites:[],useWhitelist:!1,autoUpdate:!0,updateInterval:60,maxElementsToScan:1e3,debounceDelay:300};console.log("Currency Converter Extension: Content script loaded");let p=g,m={},y=!1,h=!1,f=!1;async function x(){try{if(f&&!h)return console.log("Already initialized, re-scanning page..."),void b();console.log("Initializing currency converter..."),await d.loadLanguage(),h||(h=!0,function(){if(document.getElementById("currency-converter-loading"))return;const e=document.createElement("div");e.id="currency-converter-loading",e.innerHTML=`\n    <div style="display: flex; align-items: center; gap: 12px;">\n      <div class="spinner"></div>\n      <span>${d.t("fetchingRates")}</span>\n    </div>\n  `,e.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    color: white;\n    padding: 16px 24px;\n    border-radius: 12px;\n    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);\n    z-index: 999999;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 14px;\n    font-weight: 600;\n  ";const n=document.createElement("style");n.id="currency-converter-loading-style",n.textContent="\n    .spinner {\n      width: 20px;\n      height: 20px;\n      border: 3px solid rgba(255, 255, 255, 0.3);\n      border-top-color: white;\n      border-radius: 50%;\n      animation: spin 0.8s linear infinite;\n    }\n    @keyframes spin {\n      to { transform: rotate(360deg); }\n    }\n  ",document.head.appendChild(n),document.body.appendChild(e)}());const e=await chrome.storage.local.get("settings");if(p=e.settings||g,console.log("Settings loaded:",p),p.language&&await d.setLanguage(p.language),!p.enabled)return console.log("Extension is disabled"),C(),h=!1,void(f=!0);console.log("Fetching exchange rates...");const n=await chrome.runtime.sendMessage({type:"GET_RATES",payload:{baseCurrency:p.baseCurrency}});if(!n||!n.rates)throw new Error("Failed to get rates from response");m=n.rates,console.log("Rates loaded:",Object.keys(m).length,"currencies"),C(),h=!1,f=!0,b()}catch(e){console.error("Failed to initialize:",e),C(),h=!1,f=!0,e instanceof Error&&e.message.includes("Extension context invalidated")?(console.log("Extension context invalidated, will retry on next visibility change"),f=!1):function(e,n="success"){const t=document.createElement("div");t.innerHTML=`\n    <div style="display: flex; align-items: center; gap: 8px;">\n      <span style="font-size: 20px;">${"success"===n?"üí±":"‚ö†Ô∏è"}</span>\n      <span>${e}</span>\n    </div>\n  `,t.style.cssText=`\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: linear-gradient(135deg, ${"success"===n?"#667eea 0%, #764ba2":"#ef4444 0%, #dc2626"} 100%);\n    color: white;\n    padding: 16px 24px;\n    border-radius: 12px;\n    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);\n    z-index: 999999;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 14px;\n    font-weight: 600;\n    animation: slideInRight 0.3s ease;\n  `;const a=document.createElement("style");a.textContent="\n    @keyframes slideInRight {\n      from {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n      to {\n        transform: translateX(0);\n        opacity: 1;\n      }\n    }\n    @keyframes slideOutRight {\n      from {\n        transform: translateX(0);\n        opacity: 1;\n      }\n      to {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n    }\n  ",document.head.appendChild(a),document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease",setTimeout(()=>{t.remove(),a.remove()},300)},3e3)}(d.t("fetchRatesFailed"),"error")}}function C(){const e=document.getElementById("currency-converter-loading"),n=document.getElementById("currency-converter-loading-style");e&&e.remove(),n&&n.remove()}function b(){if(y)console.log("Already processing, skipping scan");else{y=!0,console.log("Starting currency scan...");try{if(u.removeAll(),!p.enabled)return void console.log("Extension is disabled, skipping scan");if(!m||0===Object.keys(m).length)return void console.log("No rates available, skipping scan");const n=function(e){const n=[],t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:e=>{const n=e.parentElement;if(!n)return NodeFilter.FILTER_REJECT;const t=n.tagName.toLowerCase();return"script"===t||"style"===t||"noscript"===t||n.classList.contains("currency-converter-overlay")?NodeFilter.FILTER_REJECT:e.textContent&&e.textContent.trim().length>0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}});let a;for(;a=t.nextNode();)n.push(a);return n}(document.body);console.log("Found",n.length,"text nodes to scan");let l=0;n.forEach(n=>{if(!n.textContent)return;const d=function(n){if(!n||"string"!=typeof n)return[];const c=[],l=new Set;try{let d;for(t.lastIndex=0;null!==(d=t.exec(n));){const n=d[1],t=d[2],a=s(n);if(a&&e.includes(a)){const e=i(t);if(e>0){const n=`${d.index}-${a}-${e}`;l.has(n)||(c.push({amount:e,currency:a,rawText:d[0],confidence:.9}),l.add(n))}}}for(a.lastIndex=0;null!==(d=a.exec(n));){const n=d[1],t=s(d[2]);if(t&&e.includes(t)){const e=i(n);if(e>0){const n=`${d.index}-${t}-${e}`;l.has(n)||(c.push({amount:e,currency:t,rawText:d[0],confidence:.95}),l.add(n))}}}for(o.lastIndex=0;null!==(d=o.exec(n));){const n=d[1],t=d[2],a=s(n);if(a&&e.includes(a)){const e=i(t);if(e>0){const n=`${d.index}-${a}-${e}`;l.has(n)||(c.push({amount:e,currency:a,rawText:d[0],confidence:.95}),l.add(n))}}}for(r.lastIndex=0;null!==(d=r.exec(n));){const e=d[1],n=d[2],t=d[3];if(e||t){const e=i(n);if(e>0){const n=`${d.index}-CNY-${e}`;l.has(n)||(c.push({amount:e,currency:"CNY",rawText:d[0],confidence:.85}),l.add(n))}}}}catch(e){return console.warn("Currency detection error:",e),[]}return c}(n.textContent);0!==d.length&&d.forEach(e=>{if(e.currency===p.baseCurrency)return;const t=function(e,n,t,a,o=2){try{if(n===t)return{originalAmount:e,originalCurrency:n,convertedAmount:e,targetCurrency:t,rate:1,formattedResult:c(e,t,o)};if(!a[n]||!a[t])return console.warn(`Missing rate for ${n} or ${t}`),null;const r=a[t]/a[n],s=e*r;if(!isFinite(s))throw new Error("Conversion resulted in invalid number");return{originalAmount:e,originalCurrency:n,convertedAmount:s,targetCurrency:t,rate:r,formattedResult:c(s,t,o)}}catch(e){return console.error("Conversion error:",e),null}}(e.amount,e.currency,p.baseCurrency,m,p.decimalPlaces);t&&(function(e,n){try{const t=e.parentElement;if(!t)return;const a=u.create(n,p.showExchangeRate);e.nextSibling?t.insertBefore(a,e.nextSibling):t.appendChild(a)}catch(e){console.error("Failed to insert overlay:",e)}}(n,t),l++)})}),l>0?console.log(`‚úì Converted ${l} currency amounts`):console.log("No currency amounts found to convert")}catch(e){console.error("Failed to scan and convert:",e)}finally{y=!1}}}chrome.storage.onChanged.addListener((e,n)=>{if("local"===n&&e.settings){const n=e.settings.newValue,t=e.settings.oldValue||{};p=n,n.language&&n.language!==t.language&&d.setLanguage(n.language),console.log("Settings changed:",n),n.enabled?t.enabled&&t.baseCurrency===n.baseCurrency&&t.decimalPlaces===n.decimalPlaces||x():u.removeAll()}}),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&(console.log("Tab became visible, checking state..."),console.log("- Initialized:",f),console.log("- Enabled:",p.enabled),console.log("- Has rates:",Object.keys(m).length>0),f&&p.enabled&&Object.keys(m).length>0?(console.log("Re-scanning page..."),b()):f?p.enabled?0===Object.keys(m).length&&(console.log("No rates available, re-initializing..."),x()):console.log("Extension is disabled, skipping scan"):(console.log("Not initialized yet, initializing..."),x()))});const v=new MutationObserver(e=>{e.some(e=>e.addedNodes.length>0||"characterData"===e.type&&e.target.textContent)&&f&&p.enabled&&!y&&(clearTimeout(window.currencyConverterDebounce),window.currencyConverterDebounce=setTimeout(()=>{console.log("DOM changed, re-scanning..."),b()},500))});function R(){console.log("Currency Converter: Starting up..."),console.log("- Document ready state:",document.readyState),console.log("- URL:",window.location.href),x();try{v.observe(document.body,{childList:!0,subtree:!0,characterData:!0}),console.log("DOM observer started")}catch(e){console.error("Failed to start DOM observer:",e)}}"loading"===document.readyState?(console.log("Document still loading, waiting for DOMContentLoaded..."),document.addEventListener("DOMContentLoaded",R)):(console.log("Document already loaded, starting immediately..."),R()),chrome.runtime.onMessage.addListener((e,n,t)=>("EXTENSION_RELOADED"===e.type&&(console.log("Extension reloaded, re-initializing..."),f=!1,h=!1,x(),t({success:!0})),!0)),window.addEventListener("error",e=>{e.message.includes("Extension context invalidated")&&(console.log("Extension context invalidated, resetting state..."),f=!1,h=!1)})})();