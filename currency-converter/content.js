(()=>{"use strict";const e=["USD","EUR","GBP","JPY","CNY","CAD","AUD","CHF","HKD","SGD","KRW","INR","RUB","BRL","MXN","ZAR"],n={$:"USD","‚Ç¨":"EUR","¬£":"GBP","Ôø•":"CNY","‚Çπ":"INR","‚ÇΩ":"RUB","‚Ç©":"KRW",C$:"CAD",A$:"AUD",HK$:"HKD",S$:"SGD",R$:"BRL",R:"ZAR"},t=/(?<![A-Z])([¬•Ôø•$‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]|C\$|A\$|HK\$|S\$|R\$|R)\s*(\d+(?:[,\s]\d{3})*(?:\.\d+)?)/gi,o=/(?:^|[^\d])(\d+(?:[,\s]\d{3})*(?:\.\d+)?)\s+(USD|EUR|GBP|JPY|CNY|CAD|AUD|CHF|HKD|SGD|KRW|INR|RUB|BRL|MXN|ZAR|RMB)\b/gi,a=/\b(USD|EUR|GBP|JPY|CNY|CAD|AUD|CHF|HKD|SGD|KRW|INR|RUB|BRL|MXN|ZAR|RMB)\s+(\d+(?:[,\s]\d{3})*(?:\.\d+)?)/gi,r=/(?:(¬•|Ôø•)\s*(\d+(?:[,\s]\d{3})*(?:\.\d+)?)|(\d+(?:[,\s]\d{3})*(?:\.\d+)?)\s*(ÂÖÉ|‰∫∫Ê∞ëÂ∏Å|RMB))/g;function s(t,o,a){const r=t.trim().toUpperCase();if("RMB"===r)return"CNY";if("ÂÖÉ"===r||"‰∫∫Ê∞ëÂ∏Å"===r)return"CNY";if("¬•"===t&&void 0!==o&&void 0!==a)return function(e,n){const t=Math.max(0,n-20),o=Math.min(e.length,n+50),a=e.substring(t,o);return/[ÂÖÉ‰∫∫Ê∞ëÂ∏Å]|RMB|CNY/i.test(a)?"CNY":/[ÂÜÜ]|Êó•ÂÖÉ|JPY/i.test(a)?"JPY":(/[\u4e00-\u9fa5]/.test(a),"CNY")}(o,a);return n[t]||(e.includes(r)?r:"")}function c(e){const n=e.replace(/[\s,]/g,""),t=parseFloat(n);return isNaN(t)||!isFinite(t)||t<0?0:t}function i(e,n,t=2){const o=Math.max(2,t),a=e.toFixed(o).split(".");return a[0]=a[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),`${a.join(".")} ${n}`}const l={zh:{appName:"Ê±áÁéáËΩ¨Êç¢Âô®",appSubtitle:"ÂÆûÊó∂Ë¥ßÂ∏ÅËΩ¨Êç¢Âä©Êâã",controlTitle:"ÂäüËÉΩÊéßÂà∂",autoConvertLabel:"Ëá™Âä®ËΩ¨Êç¢",autoConvertDesc:"ÂºÄÂêØÂêéËá™Âä®ËØÜÂà´Âπ∂ËΩ¨Êç¢È°µÈù¢Ë¥ßÂ∏Å",settingsTitle:"ËΩ¨Êç¢ËÆæÁΩÆ",baseCurrencyLabel:"Êú¨Âú∞Ë¥ßÂ∏Å",decimalPlacesLabel:"Â∞èÊï∞‰ΩçÊï∞",showRateLabel:"ÊÇ¨ÂÅúÊó∂ÊòæÁ§∫Ê±áÁéá‰ø°ÊÅØ",currencyCNY:"üá®üá≥ ‰∫∫Ê∞ëÂ∏Å (CNY)",currencyUSD:"üá∫üá∏ ÁæéÂÖÉ (USD)",currencyEUR:"üá™üá∫ Ê¨ßÂÖÉ (EUR)",currencyGBP:"üá¨üáß Ëã±Èïë (GBP)",currencyJPY:"üáØüáµ Êó•ÂÖÉ (JPY)",currencyKRW:"üá∞üá∑ Èü©ÂÖÉ (KRW)",currencyHKD:"üá≠üá∞ Ê∏ØÂ∏Å (HKD)",statusTitle:"Ê±áÁéáÁä∂ÊÄÅ",statusLoading:"Âä†ËΩΩ‰∏≠...",statusLatest:"Ê±áÁéáÁä∂ÊÄÅ: ÊúÄÊñ∞",statusExpired:"Ê±áÁéáÁä∂ÊÄÅ: Â∑≤ËøáÊúü",statusNotCached:"Ê±áÁéáÁä∂ÊÄÅ: Êú™ÁºìÂ≠ò",statusFailed:"Ê±áÁéáÁä∂ÊÄÅ: Âä†ËΩΩÂ§±Ë¥•",statusDesc:"Ê±áÁéáÊï∞ÊçÆÊØèÂ∞èÊó∂Êõ¥Êñ∞",clearCacheBtn:"Ê∏ÖÈô§ÁºìÂ≠ò",settingsSaved:"ËÆæÁΩÆÂ∑≤Ëá™Âä®‰øùÂ≠ò",settingsSaveFailed:"‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•",cacheCleared:"ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§",cacheClearFailed:"Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•",settingsLoadFailed:"Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•",convertedCount:"Â∑≤ËΩ¨Êç¢",conversionDisabled:"Ëá™Âä®ËΩ¨Êç¢Â∑≤Á¶ÅÁî®",fetchingRates:"Ê≠£Âú®Ëé∑ÂèñÊ±áÁéáÊï∞ÊçÆ...",fetchRatesFailed:"Ëé∑ÂèñÊ±áÁéáÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•",footerText:"Êï∞ÊçÆÁî± ExchangeRate-API Êèê‰æõ",rateInfo:"Ê±áÁéá",clickToConfig:"ÁÇπÂáªÊèí‰ª∂ÂõæÊ†áÂèØÈÖçÁΩÆËÆæÁΩÆ",minutesAgo:"ÂàÜÈíüÂâçÊõ¥Êñ∞",hoursAgo:"Â∞èÊó∂Ââç"},en:{appName:"Currency Converter",appSubtitle:"Real-time Currency Conversion Assistant",controlTitle:"Function Control",autoConvertLabel:"Auto Convert",autoConvertDesc:"Automatically detect and convert currencies on page",settingsTitle:"Conversion Settings",baseCurrencyLabel:"Base Currency",decimalPlacesLabel:"Decimal Places",showRateLabel:"Show exchange rate on hover",currencyCNY:"üá®üá≥ Chinese Yuan (CNY)",currencyUSD:"üá∫üá∏ US Dollar (USD)",currencyEUR:"üá™üá∫ Euro (EUR)",currencyGBP:"üá¨üáß British Pound (GBP)",currencyJPY:"üáØüáµ Japanese Yen (JPY)",currencyKRW:"üá∞üá∑ Korean Won (KRW)",currencyHKD:"üá≠üá∞ Hong Kong Dollar (HKD)",statusTitle:"Exchange Rate Status",statusLoading:"Loading...",statusLatest:"Status: Latest",statusExpired:"Status: Expired",statusNotCached:"Status: Not Cached",statusFailed:"Status: Load Failed",statusDesc:"Exchange rates update hourly",clearCacheBtn:"Clear Cache",settingsSaved:"Settings saved automatically",settingsSaveFailed:"Failed to save settings",cacheCleared:"Cache cleared",cacheClearFailed:"Failed to clear cache",settingsLoadFailed:"Failed to load settings",convertedCount:"Converted",conversionDisabled:"Auto conversion disabled",fetchingRates:"Fetching exchange rates...",fetchRatesFailed:"Failed to fetch rates, please check network",footerText:"Data provided by ExchangeRate-API",rateInfo:"Rate",clickToConfig:"Click extension icon to configure",minutesAgo:"min ago",hoursAgo:"hr ago"}},d=new class{constructor(){this.currentLanguage="zh",this.loadLanguage()}async loadLanguage(){try{const e=await chrome.storage.local.get("language");this.currentLanguage=e.language||"zh"}catch(e){console.error("Failed to load language:",e)}}async setLanguage(e){this.currentLanguage=e;try{await chrome.storage.local.set({language:e})}catch(e){console.error("Failed to save language:",e)}}getLanguage(){return this.currentLanguage}t(e){return l[this.currentLanguage][e]}getMessages(){return l[this.currentLanguage]}},u=new class{create(e,n=!1){const t=document.createElement("span");t.className="currency-converter-overlay",t.style.cssText="\n      display: inline-block;\n      padding: 2px 6px;\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      color: white;\n      border-radius: 3px;\n      font-size: 0.7em;\n      font-weight: 600;\n      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;\n      white-space: nowrap;\n      cursor: help;\n      box-shadow: 0 1px 4px rgba(16, 185, 129, 0.3);\n      transition: all 0.2s ease;\n      letter-spacing: 0.3px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      position: relative;\n      vertical-align: middle;\n      margin: 0 2px;\n      line-height: 1.2;\n      opacity: 0.9;\n    ";const o=document.createElement("span");if(o.textContent=`‚âà${e.formattedResult}`,o.style.cssText="\n      font-variant-numeric: tabular-nums;\n    ",t.appendChild(o),t.addEventListener("mouseenter",()=>{t.style.opacity="1",t.style.transform="scale(1.1)",t.style.boxShadow="0 2px 8px rgba(16, 185, 129, 0.5)",t.style.zIndex="999999"}),t.addEventListener("mouseleave",()=>{t.style.opacity="0.9",t.style.transform="scale(1)",t.style.boxShadow="0 1px 4px rgba(16, 185, 129, 0.3)",t.style.zIndex=""}),n){const n=(d.getLanguage(),`üí± ${d.t("rateInfo")}: 1 ${e.originalCurrency} = ${e.rate.toFixed(4)} ${e.targetCurrency}`);t.title=n}else t.title=d.t("clickToConfig");return t}removeAll(){document.querySelectorAll(".currency-converter-overlay").forEach(e=>e.remove())}},g={enabled:!0,baseCurrency:"CNY",displayFormat:"inline",decimalPlaces:2,showOriginalCurrency:!0,showExchangeRate:!0,language:"zh",enabledSites:[],disabledSites:[],useWhitelist:!1,autoUpdate:!0,updateInterval:60,maxElementsToScan:1e3,debounceDelay:300};console.log("Currency Converter Extension: Content script loaded");let y=g,p={},m=!1,h=!1,f=!1;async function x(){try{if(f&&!h)return console.log("Already initialized, re-scanning page..."),void C();console.log("Initializing currency converter..."),await d.loadLanguage(),h||(h=!0,function(){if(document.getElementById("currency-converter-loading"))return;const e=document.createElement("div");e.id="currency-converter-loading",e.innerHTML=`\n    <div style="display: flex; align-items: center; gap: 12px;">\n      <div class="spinner"></div>\n      <span>${d.t("fetchingRates")}</span>\n    </div>\n  `,e.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    color: white;\n    padding: 16px 24px;\n    border-radius: 12px;\n    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);\n    z-index: 999999;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 14px;\n    font-weight: 600;\n  ";const n=document.createElement("style");n.id="currency-converter-loading-style",n.textContent="\n    .spinner {\n      width: 20px;\n      height: 20px;\n      border: 3px solid rgba(255, 255, 255, 0.3);\n      border-top-color: white;\n      border-radius: 50%;\n      animation: spin 0.8s linear infinite;\n    }\n    @keyframes spin {\n      to { transform: rotate(360deg); }\n    }\n  ",document.head.appendChild(n),document.body.appendChild(e)}());const e=await chrome.storage.local.get("settings");if(y=e.settings||g,console.log("Settings loaded:",y),console.log("Base currency (Êú¨Âú∞Ë¥ßÂ∏Å):",y.baseCurrency),console.log("Enabled:",y.enabled),y.language&&await d.setLanguage(y.language),!y.enabled)return console.log("Extension is disabled"),b(),h=!1,void(f=!0);console.log("Fetching exchange rates...");const n=await chrome.runtime.sendMessage({type:"GET_RATES",payload:{baseCurrency:y.baseCurrency}});if(!n||!n.rates)throw new Error("Failed to get rates from response");p=n.rates,console.log("Rates loaded:",Object.keys(p).length,"currencies"),b(),h=!1,f=!0,C()}catch(e){console.error("Failed to initialize:",e),b(),h=!1,f=!0,e instanceof Error&&e.message.includes("Extension context invalidated")?(console.log("Extension context invalidated, will retry on next visibility change"),f=!1):function(e,n="success"){const t=document.createElement("div");t.innerHTML=`\n    <div style="display: flex; align-items: center; gap: 8px;">\n      <span style="font-size: 20px;">${"success"===n?"üí±":"‚ö†Ô∏è"}</span>\n      <span>${e}</span>\n    </div>\n  `,t.style.cssText=`\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: linear-gradient(135deg, ${"success"===n?"#667eea 0%, #764ba2":"#ef4444 0%, #dc2626"} 100%);\n    color: white;\n    padding: 16px 24px;\n    border-radius: 12px;\n    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);\n    z-index: 999999;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 14px;\n    font-weight: 600;\n    animation: slideInRight 0.3s ease;\n  `;const o=document.createElement("style");o.textContent="\n    @keyframes slideInRight {\n      from {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n      to {\n        transform: translateX(0);\n        opacity: 1;\n      }\n    }\n    @keyframes slideOutRight {\n      from {\n        transform: translateX(0);\n        opacity: 1;\n      }\n      to {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n    }\n  ",document.head.appendChild(o),document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease",setTimeout(()=>{t.remove(),o.remove()},300)},3e3)}(d.t("fetchRatesFailed"),"error")}}function b(){const e=document.getElementById("currency-converter-loading"),n=document.getElementById("currency-converter-loading-style");e&&e.remove(),n&&n.remove()}function C(){if(m)console.log("Already processing, skipping scan");else{m=!0,console.log("=== Starting Currency Scan ==="),console.log("Settings:",{enabled:y.enabled,baseCurrency:y.baseCurrency,decimalPlaces:y.decimalPlaces}),console.log("Available rates:",Object.keys(p).length,"currencies");try{if(u.removeAll(),!y.enabled)return void console.log("Extension is disabled, skipping scan");if(!p||0===Object.keys(p).length)return void console.log("No rates available, skipping scan");const n=function(e){const n=[],t=new Set,o=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>{const n=e,t=n.tagName.toLowerCase();if("script"===t||"style"===t||"noscript"===t)return NodeFilter.FILTER_REJECT;if(n.classList.contains("currency-converter-overlay"))return NodeFilter.FILTER_REJECT;const o=n.textContent||"";return o.length>500||n.children.length>10?NodeFilter.FILTER_SKIP:/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]|\d+/.test(o)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});let a;for(;a=o.nextNode();){const e=a;t.has(e)||(n.push(e),t.add(e))}const r=new Set;n.forEach(e=>{const t=e.textContent||"",o=/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]/.test(t),a=n.filter(n=>n!==e&&e.contains(n));a.length>0&&(o?a.forEach(e=>r.add(e)):r.add(e))});const s=n.filter(e=>!r.has(e));return console.log(`Element selection: ${n.length} total, ${s.length} after filtering, ${r.size} removed`),s}(document.body);console.log("Found",n.length,"elements to scan");let l=0;const d=new Set,g=new Map;n.forEach(n=>{if(d.has(n))return;d.add(n);const u=n.textContent||"";if(!u.trim())return;const m=function(n){if(!n||"string"!=typeof n)return[];const i=[],l=new Set;try{let d;for(t.lastIndex=0;null!==(d=t.exec(n));){const t=d[1],o=d[2],a=s(t,n,d.index);if(a&&e.includes(a)){const e=c(o);if(e>0){const n=`${d.index}-${a}-${e}`;l.has(n)||(i.push({amount:e,currency:a,rawText:d[0],confidence:.9}),l.add(n))}}}for(o.lastIndex=0;null!==(d=o.exec(n));){const n=d[1],t=s(d[2]);if(t&&e.includes(t)){const e=c(n);if(e>0){const n=`${d.index}-${t}-${e}`;l.has(n)||(i.push({amount:e,currency:t,rawText:d[0],confidence:.95}),l.add(n))}}}for(a.lastIndex=0;null!==(d=a.exec(n));){const n=d[1],t=d[2],o=s(n);if(o&&e.includes(o)){const e=c(t);if(e>0){const n=`${d.index}-${o}-${e}`;l.has(n)||(i.push({amount:e,currency:o,rawText:d[0],confidence:.95}),l.add(n))}}}for(r.lastIndex=0;null!==(d=r.exec(n));){const e=d[1],n=d[2],t=d[3],o=d[4],a=n||t;if((e||o)&&a){const e=c(a);if(e>0){const n=`${d.index}-CNY-${e}`;l.has(n)||(i.push({amount:e,currency:"CNY",rawText:d[0],confidence:.95}),l.add(n))}}}}catch(e){return console.warn("Currency detection error:",e),[]}return i}(u);m.length>0&&console.log(`üìç Element text: "${u.substring(0,100)}"`,"Detections:",m.length),0!==m.length&&m.forEach(e=>{const t=`${e.amount}-${e.currency}-${u.substring(0,50)}`;if(g.has(t)){const o=g.get(t);if(o&&(o.contains(n)||n.contains(o)))return void console.log(`‚è≠ Skipping duplicate (parent-child): ${e.amount} ${e.currency}`)}if(g.set(t,n),console.log(`Detected: ${e.amount} ${e.currency}, Base: ${y.baseCurrency}`),e.currency===y.baseCurrency)return void console.log(`‚úì Skipping ${e.currency} ${e.amount} (same as base currency, no conversion needed)`);console.log(`‚Üí Converting ${e.currency} to ${y.baseCurrency}`);const o=function(e,n,t,o,a=2){try{if(n===t)return null;if(!o[n]||!o[t])return console.warn(`Missing rate for ${n} or ${t}`),null;const r=o[t]/o[n],s=e*r;if(!isFinite(s))throw new Error("Conversion resulted in invalid number");return{originalAmount:e,originalCurrency:n,convertedAmount:s,targetCurrency:t,rate:r,formattedResult:i(s,t,a)}}catch(e){return console.error("Conversion error:",e),null}}(e.amount,e.currency,y.baseCurrency,p,y.decimalPlaces);o&&(function(e,n){try{let t=e.nextElementSibling;if(t&&t.classList.contains("currency-converter-overlay"))return;const o=document.createElement("span");o.className="currency-converter-overlay",o.style.cssText="\n      display: inline-block;\n      margin-left: 6px;\n      padding: 2px 8px;\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      color: white;\n      border-radius: 4px;\n      font-size: 0.85em;\n      font-weight: 600;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n      white-space: nowrap;\n      box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3);\n      vertical-align: middle;\n      line-height: 1.4;\n      opacity: 0.95;\n    ",o.textContent=`‚âà${n.formattedResult}`,o.addEventListener("mouseenter",()=>{o.style.opacity="1",o.style.transform="scale(1.05)"}),o.addEventListener("mouseleave",()=>{o.style.opacity="0.95",o.style.transform="scale(1)"});const a=e.parentElement;if(!a)return void console.warn("Element has no parent, cannot insert overlay");e.nextSibling?a.insertBefore(o,e.nextSibling):a.appendChild(o),console.log("‚úì Inserted overlay after element:",e.tagName,e.textContent?.substring(0,30))}catch(e){console.error("Failed to insert overlay after element:",e)}}(n,o),l++)})}),console.log("=== Scan Summary ==="),console.log(`Total elements scanned: ${n.length}`),console.log(`Converted: ${l}`),l>0?console.log(`‚úì Converted ${l} currency amounts`):console.log("‚ÑπÔ∏è No foreign currency found (all amounts are CNY or no amounts detected)")}catch(e){console.error("Failed to scan and convert:",e)}finally{m=!1}}}chrome.storage.onChanged.addListener((e,n)=>{if("local"===n&&e.settings){const n=e.settings.newValue,t=e.settings.oldValue||{};y=n,n.language&&n.language!==t.language&&d.setLanguage(n.language),console.log("Settings changed:",n),n.enabled?t.enabled&&t.baseCurrency===n.baseCurrency&&t.decimalPlaces===n.decimalPlaces||x():u.removeAll()}}),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&(console.log("Tab became visible, checking state..."),console.log("- Initialized:",f),console.log("- Enabled:",y.enabled),console.log("- Has rates:",Object.keys(p).length>0),f&&y.enabled&&Object.keys(p).length>0?(console.log("Re-scanning page..."),C()):f?y.enabled?0===Object.keys(p).length&&(console.log("No rates available, re-initializing..."),x()):console.log("Extension is disabled, skipping scan"):(console.log("Not initialized yet, initializing..."),x()))});const v=new MutationObserver(e=>{e.some(e=>e.addedNodes.length>0||"characterData"===e.type&&e.target.textContent)&&f&&y.enabled&&!m&&(clearTimeout(window.currencyConverterDebounce),window.currencyConverterDebounce=setTimeout(()=>{console.log("DOM changed, re-scanning..."),C()},500))});function E(){console.log("Currency Converter: Starting up..."),console.log("- Document ready state:",document.readyState),console.log("- URL:",window.location.href),x();try{v.observe(document.body,{childList:!0,subtree:!0,characterData:!0}),console.log("DOM observer started")}catch(e){console.error("Failed to start DOM observer:",e)}}"loading"===document.readyState?(console.log("Document still loading, waiting for DOMContentLoaded..."),document.addEventListener("DOMContentLoaded",E)):(console.log("Document already loaded, starting immediately..."),E()),chrome.runtime.onMessage.addListener((e,n,t)=>("EXTENSION_RELOADED"===e.type&&(console.log("Extension reloaded, re-initializing..."),f=!1,h=!1,x(),t({success:!0})),!0)),window.addEventListener("error",e=>{e.message.includes("Extension context invalidated")&&(console.log("Extension context invalidated, resetting state..."),f=!1,h=!1)})})();