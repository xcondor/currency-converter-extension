(()=>{"use strict";const e=["USD","EUR","GBP","JPY","CNY","CAD","AUD","CHF","HKD","SGD","KRW","INR","RUB","BRL","MXN","ZAR"],n={$:"USD","‚Ç¨":"EUR","¬£":"GBP","Ôø•":"CNY","‚Çπ":"INR","‚ÇΩ":"RUB","‚Ç©":"KRW",C$:"CAD",A$:"AUD",HK$:"HKD",S$:"SGD",R$:"BRL",R:"ZAR"},t=/(?<![A-Z])([¬•Ôø•$‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]|C\$|A\$|HK\$|S\$|R\$|R)\s*(\d{1,3}(?:,\d{3})*(?:\.\d{1,2})?|\d{1,6}(?:\.\d{1,2})?)(?![,.\d])/gi,o=/(?:^|[^\d])(\d+(?:[,\s]\d{3})*(?:\.\d+)?)\s+(USD|EUR|GBP|JPY|CNY|CAD|AUD|CHF|HKD|SGD|KRW|INR|RUB|BRL|MXN|ZAR|RMB)\b/gi,s=/\b(USD|EUR|GBP|JPY|CNY|CAD|AUD|CHF|HKD|SGD|KRW|INR|RUB|BRL|MXN|ZAR|RMB)\s+(\d+(?:[,\s]\d{3})*(?:\.\d+)?)/gi,r=/(?:(¬•|Ôø•)\s*(\d+(?:[,\s]\d{3})*(?:\.\d+)?)|(\d+(?:[,\s]\d{3})*(?:\.\d+)?)\s*(ÂÖÉ|‰∫∫Ê∞ëÂ∏Å|RMB))/g;function a(t,o,s){const r=t.trim().toUpperCase();if("RMB"===r)return"CNY";if("ÂÖÉ"===r||"‰∫∫Ê∞ëÂ∏Å"===r)return"CNY";if("¬•"===t&&void 0!==o&&void 0!==s)return function(e,n){const t=Math.max(0,n-20),o=Math.min(e.length,n+50),s=e.substring(t,o);return/[ÂÖÉ‰∫∫Ê∞ëÂ∏Å]|RMB|CNY/i.test(s)?"CNY":/[ÂÜÜ]|Êó•ÂÖÉ|JPY/i.test(s)?"JPY":(/[\u4e00-\u9fa5]/.test(s),"CNY")}(o,s);return n[t]||(e.includes(r)?r:"")}function c(e){const n=e.replace(/[\s,]/g,""),t=parseFloat(n);return isNaN(t)||!isFinite(t)||t<0?0:t}function l(e,n){if(e<.01||e>999999)return!1;if(/\d+\+?\s*[‰∫∫+]+(Ë¥≠‰π∞|‰ªòÊ¨æ|ËØÑ‰ª∑|Â∑≤Ë¥≠|Â∑≤‰ªò|Â∑≤ÂîÆ|ÈîÄÈáè|Êàê‰∫§)/.test(n)){const t=e.toString();if(new RegExp(`${t}\\+?\\s*[‰∫∫+]+(Ë¥≠‰π∞|‰ªòÊ¨æ|ËØÑ‰ª∑|Â∑≤Ë¥≠|Â∑≤‰ªò|Â∑≤ÂîÆ|ÈîÄÈáè|Êàê‰∫§)`).test(n))return console.log(`‚è≠ Skipping purchase count: ${e} (matched pattern: ${t}+‰∫∫Ë¥≠‰π∞)`),!1}if(e>1e4){const e=/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]/.test(n),t=/\d+\s*[‰∫∫+]+(Ë¥≠‰π∞|‰ªòÊ¨æ|ËØÑ‰ª∑)/.test(n);if(e&&t)return!1;if(/ÈªÑÈáë|Ë∂≥Èáë|Á∫ØÂ∫¶|KÈáë|AU|9999|999|990|916/.test(n))return!1}if(e>=1e3&&e%1e3==0&&/ÈªÑÈáë|Ë∂≥Èáë|Á∫ØÂ∫¶|KÈáë|AU|9999|999|990|916/.test(n))return!1;const t=e.toString();return!(4===t.length&&/^(\d)\1{3}$/.test(t)&&!/‰ª∑Ê†º|ÂîÆ‰ª∑|¬•|ÂÖÉ|RMB/.test(n))}function i(e,n,t){const o=e.toString(),s=n.substring(t).match(/^[¬•Ôø•$‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]\s*\d+(\d{2})(‰∏á|ÂçÉ|\+|‰∫∫)/);if(s&&s[1]){const n=s[1];if(o.endsWith(n)){const t=o.substring(0,o.length-n.length),s=parseFloat(t);if(!isNaN(s)&&s>0)return console.log(`üîß Cleaned amount: ${e} ‚Üí ${s} (removed suffix: ${n})`),s}}return e}function d(n){if(!n||"string"!=typeof n)return[];const d=[],u=new Set;try{let g;for(t.lastIndex=0;null!==(g=t.exec(n));){const t=g[1],o=g[2],s=a(t,n,g.index);if(s&&e.includes(s)){let e=c(o);if(e=i(e,n,g.index),e>0&&l(e,n)){const n=`${g.index}-${s}-${e}`;u.has(n)||(d.push({amount:e,currency:s,rawText:g[0],confidence:.9}),u.add(n))}}}for(o.lastIndex=0;null!==(g=o.exec(n));){const t=g[1],o=a(g[2]);if(o&&e.includes(o)){const e=c(t);if(e>0&&l(e,n)){const n=`${g.index}-${o}-${e}`;u.has(n)||(d.push({amount:e,currency:o,rawText:g[0],confidence:.95}),u.add(n))}}}for(s.lastIndex=0;null!==(g=s.exec(n));){const t=g[1],o=g[2],s=a(t);if(s&&e.includes(s)){const e=c(o);if(e>0&&l(e,n)){const n=`${g.index}-${s}-${e}`;u.has(n)||(d.push({amount:e,currency:s,rawText:g[0],confidence:.95}),u.add(n))}}}for(r.lastIndex=0;null!==(g=r.exec(n));){const e=g[1],t=g[2],o=g[3],s=g[4],r=t||o;if((e||s)&&r){const e=c(r);if(e>0&&l(e,n)){const n=`${g.index}-CNY-${e}`;u.has(n)||(d.push({amount:e,currency:"CNY",rawText:g[0],confidence:.95}),u.add(n))}}}}catch(e){return console.warn("Currency detection error:",e),[]}return d}function u(e,n,t,o,s=2){try{if(n===t)return null;let r;r=o[n]?o[t]?o[t]/o[n]:1/o[n]:o[t];const a=e*r;if(console.log("Conversion calculation:",{amount:e,fromCurrency:n,toCurrency:t,fromRate:o[n],toRate:o[t],calculatedRate:r,converted:a}),!isFinite(a)||isNaN(a))throw new Error("Conversion resulted in invalid number");return{originalAmount:e,originalCurrency:n,convertedAmount:a,targetCurrency:t,rate:r,formattedResult:g(a,t,s)}}catch(e){return console.error("Conversion error:",e),null}}function g(e,n,t=2){const o=(Math.round(e*Math.pow(10,t))/Math.pow(10,t)).toFixed(t).split(".");return o[0]=o[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),`${o.join(".")} ${n}`}const m={zh:{appName:"Ê±áÁéáËΩ¨Êç¢Âô®",appSubtitle:"ÂÆûÊó∂Ë¥ßÂ∏ÅËΩ¨Êç¢Âä©Êâã",controlTitle:"ÂäüËÉΩÊéßÂà∂",autoConvertLabel:"Ëá™Âä®ËΩ¨Êç¢",autoConvertDesc:"ÂºÄÂêØÂêéËá™Âä®ËØÜÂà´Âπ∂ËΩ¨Êç¢È°µÈù¢Ë¥ßÂ∏Å",settingsTitle:"ËΩ¨Êç¢ËÆæÁΩÆ",baseCurrencyLabel:"Êú¨Âú∞Ë¥ßÂ∏Å",decimalPlacesLabel:"Â∞èÊï∞‰ΩçÊï∞",showRateLabel:"ÊÇ¨ÂÅúÊó∂ÊòæÁ§∫Ê±áÁéá‰ø°ÊÅØ",currencyCNY:"üá®üá≥ ‰∫∫Ê∞ëÂ∏Å (CNY)",currencyUSD:"üá∫üá∏ ÁæéÂÖÉ (USD)",currencyEUR:"üá™üá∫ Ê¨ßÂÖÉ (EUR)",currencyGBP:"üá¨üáß Ëã±Èïë (GBP)",currencyJPY:"üáØüáµ Êó•ÂÖÉ (JPY)",currencyKRW:"üá∞üá∑ Èü©ÂÖÉ (KRW)",currencyHKD:"üá≠üá∞ Ê∏ØÂ∏Å (HKD)",statusTitle:"Ê±áÁéáÁä∂ÊÄÅ",statusLoading:"Âä†ËΩΩ‰∏≠...",statusLatest:"Ê±áÁéáÁä∂ÊÄÅ: ÊúÄÊñ∞",statusExpired:"Ê±áÁéáÁä∂ÊÄÅ: Â∑≤ËøáÊúü",statusNotCached:"Ê±áÁéáÁä∂ÊÄÅ: Êú™ÁºìÂ≠ò",statusFailed:"Ê±áÁéáÁä∂ÊÄÅ: Âä†ËΩΩÂ§±Ë¥•",statusDesc:"Ê±áÁéáÊï∞ÊçÆÊØèÂ∞èÊó∂Êõ¥Êñ∞",clearCacheBtn:"Ê∏ÖÈô§ÁºìÂ≠ò",settingsSaved:"ËÆæÁΩÆÂ∑≤Ëá™Âä®‰øùÂ≠ò",settingsSaveFailed:"‰øùÂ≠òËÆæÁΩÆÂ§±Ë¥•",cacheCleared:"ÁºìÂ≠òÂ∑≤Ê∏ÖÈô§",cacheClearFailed:"Ê∏ÖÈô§ÁºìÂ≠òÂ§±Ë¥•",settingsLoadFailed:"Âä†ËΩΩËÆæÁΩÆÂ§±Ë¥•",convertedCount:"Â∑≤ËΩ¨Êç¢",conversionDisabled:"Ëá™Âä®ËΩ¨Êç¢Â∑≤Á¶ÅÁî®",fetchingRates:"Ê≠£Âú®Ëé∑ÂèñÊ±áÁéáÊï∞ÊçÆ...",fetchRatesFailed:"Ëé∑ÂèñÊ±áÁéáÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•",footerText:"Êï∞ÊçÆÁî± ExchangeRate-API Êèê‰æõ",rateInfo:"Ê±áÁéá",clickToConfig:"ÁÇπÂáªÊèí‰ª∂ÂõæÊ†áÂèØÈÖçÁΩÆËÆæÁΩÆ",minutesAgo:"ÂàÜÈíüÂâçÊõ¥Êñ∞",hoursAgo:"Â∞èÊó∂Ââç"},en:{appName:"Currency Converter",appSubtitle:"Real-time Currency Conversion Assistant",controlTitle:"Function Control",autoConvertLabel:"Auto Convert",autoConvertDesc:"Automatically detect and convert currencies on page",settingsTitle:"Conversion Settings",baseCurrencyLabel:"Base Currency",decimalPlacesLabel:"Decimal Places",showRateLabel:"Show exchange rate on hover",currencyCNY:"üá®üá≥ Chinese Yuan (CNY)",currencyUSD:"üá∫üá∏ US Dollar (USD)",currencyEUR:"üá™üá∫ Euro (EUR)",currencyGBP:"üá¨üáß British Pound (GBP)",currencyJPY:"üáØüáµ Japanese Yen (JPY)",currencyKRW:"üá∞üá∑ Korean Won (KRW)",currencyHKD:"üá≠üá∞ Hong Kong Dollar (HKD)",statusTitle:"Exchange Rate Status",statusLoading:"Loading...",statusLatest:"Status: Latest",statusExpired:"Status: Expired",statusNotCached:"Status: Not Cached",statusFailed:"Status: Load Failed",statusDesc:"Exchange rates update hourly",clearCacheBtn:"Clear Cache",settingsSaved:"Settings saved automatically",settingsSaveFailed:"Failed to save settings",cacheCleared:"Cache cleared",cacheClearFailed:"Failed to clear cache",settingsLoadFailed:"Failed to load settings",convertedCount:"Converted",conversionDisabled:"Auto conversion disabled",fetchingRates:"Fetching exchange rates...",fetchRatesFailed:"Failed to fetch rates, please check network",footerText:"Data provided by ExchangeRate-API",rateInfo:"Rate",clickToConfig:"Click extension icon to configure",minutesAgo:"min ago",hoursAgo:"hr ago"}},p=new class{constructor(){this.currentLanguage="zh",this.loadLanguage()}async loadLanguage(){try{const e=await chrome.storage.local.get("language");this.currentLanguage=e.language||"zh"}catch(e){console.error("Failed to load language:",e)}}async setLanguage(e){this.currentLanguage=e;try{await chrome.storage.local.set({language:e})}catch(e){console.error("Failed to save language:",e)}}getLanguage(){return this.currentLanguage}t(e){return m[this.currentLanguage][e]}getMessages(){return m[this.currentLanguage]}},h=new class{create(e,n=!1){const t=document.createElement("span");t.className="currency-converter-overlay",t.style.cssText="\n      display: inline-block;\n      padding: 2px 6px;\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      color: white;\n      border-radius: 3px;\n      font-size: 0.7em;\n      font-weight: 600;\n      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;\n      white-space: nowrap;\n      cursor: help;\n      box-shadow: 0 1px 4px rgba(16, 185, 129, 0.3);\n      transition: all 0.2s ease;\n      letter-spacing: 0.3px;\n      border: 1px solid rgba(255, 255, 255, 0.2);\n      position: relative;\n      vertical-align: middle;\n      margin: 0 2px;\n      line-height: 1.2;\n      opacity: 0.9;\n    ";const o=document.createElement("span");if(o.textContent=`‚âà${e.formattedResult}`,o.style.cssText="\n      font-variant-numeric: tabular-nums;\n    ",t.appendChild(o),t.addEventListener("mouseenter",()=>{t.style.opacity="1",t.style.transform="scale(1.1)",t.style.boxShadow="0 2px 8px rgba(16, 185, 129, 0.5)",t.style.zIndex="999999"}),t.addEventListener("mouseleave",()=>{t.style.opacity="0.9",t.style.transform="scale(1)",t.style.boxShadow="0 1px 4px rgba(16, 185, 129, 0.3)",t.style.zIndex=""}),n){const n=(p.getLanguage(),`üí± ${p.t("rateInfo")}: 1 ${e.originalCurrency} = ${e.rate.toFixed(4)} ${e.targetCurrency}`);t.title=n}else t.title=p.t("clickToConfig");return t}removeAll(){document.querySelectorAll(".currency-converter-overlay").forEach(e=>e.remove())}},y={enabled:!0,baseCurrency:"CNY",displayFormat:"inline",decimalPlaces:2,showOriginalCurrency:!0,showExchangeRate:!0,language:"zh",enabledSites:[],disabledSites:[],useWhitelist:!1,autoUpdate:!0,updateInterval:60,maxElementsToScan:1e3,debounceDelay:300};console.log("Currency Converter Extension: Content script loaded");let f=y,b={},x=!1,C=!1,$=!1;const v=new WeakSet,E=new Map;async function w(){try{if($&&!C)return console.log("Already initialized, re-scanning page..."),void R();console.log("Initializing currency converter..."),await p.loadLanguage(),C||(C=!0,function(){if(document.getElementById("currency-converter-loading"))return;const e=document.createElement("div");e.id="currency-converter-loading",e.innerHTML=`\n    <div style="display: flex; align-items: center; gap: 12px;">\n      <div class="spinner"></div>\n      <span>${p.t("fetchingRates")}</span>\n    </div>\n  `,e.style.cssText="\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    color: white;\n    padding: 16px 24px;\n    border-radius: 12px;\n    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);\n    z-index: 999999;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 14px;\n    font-weight: 600;\n  ";const n=document.createElement("style");n.id="currency-converter-loading-style",n.textContent="\n    .spinner {\n      width: 20px;\n      height: 20px;\n      border: 3px solid rgba(255, 255, 255, 0.3);\n      border-top-color: white;\n      border-radius: 50%;\n      animation: spin 0.8s linear infinite;\n    }\n    @keyframes spin {\n      to { transform: rotate(360deg); }\n    }\n  ",document.head.appendChild(n),document.body.appendChild(e)}());const e=await chrome.storage.local.get("settings");if(f=e.settings||y,console.log("Settings loaded:",f),console.log("Base currency (Êú¨Âú∞Ë¥ßÂ∏Å):",f.baseCurrency),console.log("Enabled:",f.enabled),f.language&&await p.setLanguage(f.language),!f.enabled)return console.log("Extension is disabled"),S(),C=!1,void($=!0);console.log("Fetching exchange rates...");const n=await chrome.runtime.sendMessage({type:"GET_RATES",payload:{baseCurrency:f.baseCurrency}});if(!n||!n.rates)throw new Error("Failed to get rates from response");b=n.rates,console.log("Rates loaded:",Object.keys(b).length,"currencies"),S(),C=!1,$=!0,N()}catch(e){console.error("Failed to initialize:",e),S(),C=!1,$=!0,e instanceof Error&&e.message.includes("Extension context invalidated")?(console.log("Extension context invalidated, will retry on next visibility change"),$=!1):function(e,n="success"){const t=document.createElement("div");t.innerHTML=`\n    <div style="display: flex; align-items: center; gap: 8px;">\n      <span style="font-size: 20px;">${"success"===n?"üí±":"‚ö†Ô∏è"}</span>\n      <span>${e}</span>\n    </div>\n  `,t.style.cssText=`\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: linear-gradient(135deg, ${"success"===n?"#667eea 0%, #764ba2":"#ef4444 0%, #dc2626"} 100%);\n    color: white;\n    padding: 16px 24px;\n    border-radius: 12px;\n    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);\n    z-index: 999999;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    font-size: 14px;\n    font-weight: 600;\n    animation: slideInRight 0.3s ease;\n  `;const o=document.createElement("style");o.textContent="\n    @keyframes slideInRight {\n      from {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n      to {\n        transform: translateX(0);\n        opacity: 1;\n      }\n    }\n    @keyframes slideOutRight {\n      from {\n        transform: translateX(0);\n        opacity: 1;\n      }\n      to {\n        transform: translateX(400px);\n        opacity: 0;\n      }\n    }\n  ",document.head.appendChild(o),document.body.appendChild(t),setTimeout(()=>{t.style.animation="slideOutRight 0.3s ease",setTimeout(()=>{t.remove(),o.remove()},300)},3e3)}(p.t("fetchRatesFailed"),"error")}}function S(){const e=document.getElementById("currency-converter-loading"),n=document.getElementById("currency-converter-loading-style");e&&e.remove(),n&&n.remove()}function N(){console.log("=== Full Rescan: Clearing all overlays and processed records ==="),h.removeAll(),E.clear(),R()}function R(){if(x)console.log("Already processing, skipping scan");else{x=!0,console.log("=== Starting Currency Scan ==="),console.log("Settings:",{enabled:f.enabled,baseCurrency:f.baseCurrency,decimalPlaces:f.decimalPlaces}),console.log("Available rates:",Object.keys(b).length,"currencies");try{if(!f.enabled)return void console.log("Extension is disabled, skipping scan");if(!b||0===Object.keys(b).length)return void console.log("No rates available, skipping scan");const e=function(e){const n=[],t=new Set,o=window.location.hostname.includes("amazon."),s=window.location.hostname.includes("jd.com"),r=window.location.hostname.includes("taobao.com")||window.location.hostname.includes("tmall.com");console.log("üîç Website detection:",{isAmazon:o,isJD:s,isTaobao:r});const a=[];o&&a.push(".a-price",".a-price-whole",".a-offscreen",".priceToPay",'[data-a-color="price"]',".a-color-price","#priceblock_ourprice","#priceblock_dealprice",".offer-price"),s&&a.push(".p-price",".J-p-price",'[class*="J-p-"]'),r&&a.push(".price",".priceInt",".priceFloat",'[class*="realPrice"]','[class*="priceText"]'),a.push('[class*="price"]','[class*="Price"]','[class*="PRICE"]','[class*="money"]','[class*="Money"]','[class*="amount"]','[class*="Amount"]','[class*="cost"]','[class*="Cost"]','[id*="price"]','[id*="Price"]'),console.log("üîç Testing selectors:");let c=0;a.forEach(o=>{try{const s=e instanceof Document?e.querySelectorAll(o):e.querySelectorAll?.(o);s&&s.length>0&&(c++,console.log(`  ‚úì ${o}: ${s.length} elements`),s.forEach(e=>{const o=e.textContent||"";(/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]/.test(o)||/\d+/.test(o))&&(t.has(e)||(n.push(e),t.add(e)))}))}catch(e){}}),console.log(`üîç Selector summary: ${c}/${a.length} selectors matched`);const l=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,{acceptNode:e=>{const n=e,o=n.tagName.toLowerCase();if("script"===o||"style"===o||"noscript"===o)return NodeFilter.FILTER_REJECT;if(n.classList.contains("currency-converter-overlay"))return NodeFilter.FILTER_REJECT;if(t.has(n))return NodeFilter.FILTER_SKIP;const s=n.textContent||"";return s.length<1||s.length>1e3||n.children.length>30?NodeFilter.FILTER_SKIP:/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]|\d+/.test(s)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP}});let i;for(;i=l.nextNode();){const e=i;t.has(e)||(n.push(e),t.add(e))}console.log(`Found ${n.length} potential price elements`),console.log("Raw elements before deduplication:"),n.slice(0,20).forEach((e,n)=>{const t=e.textContent?.substring(0,80),o=/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]/.test(e.textContent||""),s=/\d+/.test(e.textContent||"");console.log(`  ${n+1}. [${e.tagName}.${e.className||"(no class)"}] $:${o} #:${s} "${t}"`)}),o&&(console.log("\nüõí Amazon-specific price check:"),[".a-price",".a-offscreen",".a-price-whole",".priceToPay",'[data-a-color="price"]'].forEach(e=>{const n=document.querySelectorAll(e);if(console.log(`  ${e}: ${n.length} elements`),n.length>0){const e=n[0];console.log(`    Sample: "${e.textContent?.trim().substring(0,60)}"`)}})),s&&(console.log("\nüõí JD-specific price check:"),[".p-price",".J-p-price",'[class*="J-p-"]'].forEach(e=>{const n=document.querySelectorAll(e);if(console.log(`  ${e}: ${n.length} elements`),n.length>0){const e=n[0];console.log(`    Sample: "${e.textContent?.trim().substring(0,60)}"`)}})),r&&(console.log("\nüõí Taobao-specific price check:"),[".price",".priceInt",".priceFloat"].forEach(e=>{const n=document.querySelectorAll(e);if(console.log(`  ${e}: ${n.length} elements`),n.length>0){const e=n[0];console.log(`    Sample: "${e.textContent?.trim().substring(0,60)}"`)}}));const d=new Set;n.forEach(e=>{if(d.has(e))return;const t=n.filter(n=>n!==e&&e.contains(n)&&!d.has(n));if(t.length>0){/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]\s*[\d,]+\.?\d*/.test(e.textContent||"");const n=t.filter(e=>/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]\s*[\d,]+\.?\d*/.test(e.textContent||""));n.length>0&&(d.add(e),console.log(`  Removing parent (has ${n.length} children with prices):`,e.className||e.tagName))}if(!d.has(e)&&e.parentElement){const t=n.filter(n=>n!==e&&!d.has(n)&&n.parentElement===e.parentElement);if(t.length>0){const n=e.textContent?.trim()||"",o=n.match(/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]\s*[\d,]+\.?\d*/)?.[0];o&&t.forEach(n=>{const t=n.textContent?.trim()||"",s=t.match(/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]\s*[\d,]+\.?\d*/)?.[0];s===o&&e.compareDocumentPosition(n)&Node.DOCUMENT_POSITION_FOLLOWING&&(d.add(n),console.log(`  Removing duplicate sibling with same price "${o}":`,n.className||n.tagName))})}}});const u=n.filter(e=>!d.has(e));console.log(`Deduplication: removed ${d.size} elements (parents + duplicate siblings), kept ${u.length} elements`);const g=u.filter(e=>{const n=e.textContent||"",t=n.trim();return/^\d+\+?\s*[‰∫∫+]+(Ë¥≠‰π∞|‰ªòÊ¨æ|ËØÑ‰ª∑|Â∑≤Ë¥≠|Â∑≤‰ªò|Â∑≤ÂîÆ|ÈîÄÈáè|Êàê‰∫§)\s*$/.test(t)?(console.log(`  ‚è≠ Skipping purchase count element: "${t}"`),!1):!!/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]/.test(n)||!!/\b(USD|EUR|GBP|CNY|JPY|CAD|AUD)\b/i.test(n)||!(/^\d+$/.test(t)&&t.length<3)});return console.log(`Element selection: ${n.length} total, ${g.length} after filtering, ${n.length-g.length} removed`),g.length>0&&(console.log("Sample selected elements:"),g.slice(0,10).forEach((e,n)=>{const t=e.textContent?.substring(0,60),o=e.className||"(no class)";console.log(`  ${n+1}. [${e.tagName}.${o}] "${t}"`)})),g}(document.body);console.log("Found",e.length,"elements to scan");let n=0;if(e.forEach(e=>{if(v.has(e))return void console.log("‚è≠ Element already processed globally, skipping:",e.className||e.tagName);v.add(e);const t=e.textContent||"";if(!t.trim())return;const o=e.nextElementSibling;if(o&&o.classList.contains("currency-converter-overlay"))return void console.log("‚è≠ Element already has overlay, skipping:",e.className||e.tagName);const s=function(e){try{const n=e.textContent||"";if(!/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]/.test(n))return null;let t=null,o=null;const s=Array.from(e.children);for(const e of s){const n=e.textContent||"",s=n.match(/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]/);if(s&&n.trim()===s[0]){t=s[0],o=e;break}}if(!t){const n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);let o;for(;o=n.nextNode();){const e=(o.textContent||"").match(/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]/);if(e){t=e[0];break}}}if(!t)return null;let r=null,c=null;if(o){let e=o.nextElementSibling;for(;e;){const n=(e.textContent||"").match(/^\s*(\d+(?:\.\d+)?)\s*$/);if(n){c=n[1],r=e;break}e=e.nextElementSibling}}if(!r)for(const e of s){const n=e.textContent||"";if(/[$¬•Ôø•‚Ç¨¬£‚Çπ‚ÇΩ‚Ç©]/.test(n))continue;if(/[‰∫∫+]+(Ë¥≠‰π∞|‰ªòÊ¨æ|ËØÑ‰ª∑)/.test(n))continue;const t=n.match(/(\d+(?:\.\d+)?)/);if(t){c=t[1],r=e;break}}if(t&&c&&r){const e=parseFloat(c.replace(/,/g,""));if(isNaN(e)||e<=0)return null;const o=a(t,n,0);return o?(console.log(`üîç Extracted from structure: ${t}${c} ‚Üí ${e} ${o}`),{amount:e,currency:o,targetElement:r}):null}return null}catch(e){return console.error("Structure extraction error:",e),null}}(e);let r=!1;if(s){const{amount:e,currency:t,targetElement:o}=s;console.log(`üìç Structured price: ${e} ${t} from`,o.tagName);const a=`${e}-${t}`;if(E.has(a))console.log(`‚è≠ Skipping duplicate structured price: ${e} ${t}`),r=!0;else if(t===f.baseCurrency)console.log(`‚úì Skipping ${t} ${e} (same as base currency)`);else{console.log(`‚Üí Converting ${t} to ${f.baseCurrency}`);const s=u(e,t,f.baseCurrency,b,f.decimalPlaces);if(s){console.log("‚úì Conversion result:",{original:`${s.originalAmount} ${s.originalCurrency}`,converted:`${s.convertedAmount} ${s.targetCurrency}`,formatted:s.formattedResult});const e=D(o,s);e&&(E.set(a,{element:o,overlay:e}),n++,r=!0)}}}if(r)return void console.log("‚è≠ Skipping text detection (structured price already processed)");const c=d(t);c.length>0&&console.log(`üìç Element text: "${t.substring(0,100)}"`,"Detections:",c.length),0!==c.length&&c.forEach(t=>{const o=`${t.amount}-${t.currency}`;if(E.has(o))return void console.log(`‚è≠ Price already processed: ${t.amount} ${t.currency}`);const s=`${t.amount}-${t.currency}-${e.tagName}-${e.className}`;let r=!1;if(E.forEach((n,o)=>{o.includes(`${t.amount}-${t.currency}`)&&n.element===e&&(r=!0)}),r)return void console.log(`‚è≠ Already processed this exact element: ${t.amount} ${t.currency}`);let a=!1;if(E.forEach((n,o)=>{if(o.includes(`${t.amount}-${t.currency}`)){const o=n;if(o&&o.element!==e){const n=o.element;n.contains(e)||e.contains(n)?(console.log(`‚è≠ Skipping duplicate in parent/child: ${t.amount} ${t.currency}`),a=!0):n.parentElement&&e.parentElement&&n.parentElement===e.parentElement&&(console.log(`‚è≠ Skipping duplicate in sibling: ${t.amount} ${t.currency}`),a=!0)}}}),a)return;if(console.log(`Detected: ${t.amount} ${t.currency}, Base: ${f.baseCurrency}`),t.currency===f.baseCurrency)return void console.log(`‚úì Skipping ${t.currency} ${t.amount} (same as base currency, no conversion needed)`);console.log(`‚Üí Converting ${t.currency} to ${f.baseCurrency}`);const c=u(t.amount,t.currency,f.baseCurrency,b,f.decimalPlaces);if(c){console.log("‚úì Conversion result:",{original:`${c.originalAmount} ${c.originalCurrency}`,converted:`${c.convertedAmount} ${c.targetCurrency}`,formatted:c.formattedResult,rate:c.rate});const t=D(e,c);t&&(E.set(s,{element:e,overlay:t}),n++)}else console.warn(`‚úó Conversion failed for ${t.amount} ${t.currency}`)})}),console.log("=== Scan Summary ==="),console.log(`Total elements scanned: ${e.length}`),console.log(`Converted: ${n}`),0===n&&e.length>0){console.log("‚ö†Ô∏è No conversions made. Checking first few elements:"),e.slice(0,10).forEach((e,n)=>{const t=e.textContent?.substring(0,80),o=d(e.textContent||""),s=/[$¬•Ôø•‚Ç¨¬£]/.test(e.textContent||"");console.log(`  ${n+1}. [${e.tagName}.${e.className}] "${t}"`,{detections:o.length,hasSymbol:s,currencies:o.map(e=>`${e.amount} ${e.currency}`)})});const n=document.querySelectorAll('.p-price, [class*="price"]');console.log(`\nüîç Found ${n.length} elements with "price" class`),Array.from(n).slice(0,5).forEach((e,n)=>{const t=e.textContent?.trim();console.log(`  JD Price ${n+1}: "${t}"`)})}n>0?console.log(`‚úì Converted ${n} currency amounts`):console.log("‚ÑπÔ∏è No foreign currency found (all amounts are CNY or no amounts detected)")}catch(e){console.error("Failed to scan and convert:",e)}finally{x=!1}}}function D(e,n){try{let t=e.nextElementSibling;if(t&&t.classList.contains("currency-converter-overlay"))return console.log("‚ö†Ô∏è Overlay already exists, skipping"),null;const o=document.createElement("span");o.className="currency-converter-overlay",o.style.cssText="\n      display: inline-block;\n      margin-left: 6px;\n      padding: 2px 8px;\n      background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n      color: white;\n      border-radius: 4px;\n      font-size: 0.85em;\n      font-weight: 500;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n      white-space: nowrap;\n      vertical-align: middle;\n      line-height: 1.4;\n      opacity: 0.95;\n      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08);\n      transition: all 0.2s ease;\n      cursor: default;\n    ",o.textContent=`‚âà ${n.formattedResult}`,o.addEventListener("mouseenter",()=>{o.style.opacity="1",o.style.transform="translateY(-1px)",o.style.boxShadow="0 2px 6px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1)"}),o.addEventListener("mouseleave",()=>{o.style.opacity="0.95",o.style.transform="translateY(0)",o.style.boxShadow="0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.08)"});const s=e.parentElement;return s?(e.nextSibling?s.insertBefore(o,e.nextSibling):s.appendChild(o),console.log("‚úì Inserted overlay after element:",e.tagName,e.textContent?.substring(0,30)),o):(console.warn("Element has no parent, cannot insert overlay"),null)}catch(e){return console.error("Failed to insert overlay after element:",e),null}}chrome.storage.onChanged.addListener((e,n)=>{if("local"===n&&e.settings){const n=e.settings.newValue,t=e.settings.oldValue||{};f=n,n.language&&n.language!==t.language&&p.setLanguage(n.language),console.log("Settings changed:",n),n.enabled?t.enabled&&t.baseCurrency===n.baseCurrency&&t.decimalPlaces===n.decimalPlaces||N():(h.removeAll(),E.clear())}}),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&(console.log("Tab became visible, checking state..."),console.log("- Initialized:",$),console.log("- Enabled:",f.enabled),console.log("- Has rates:",Object.keys(b).length>0),$&&f.enabled&&Object.keys(b).length>0?(console.log("Re-scanning page..."),R()):$?f.enabled?0===Object.keys(b).length&&(console.log("No rates available, re-initializing..."),w()):console.log("Extension is disabled, skipping scan"):(console.log("Not initialized yet, initializing..."),w()))});const L=new MutationObserver(e=>{e.some(e=>e.addedNodes.length>0?Array.from(e.addedNodes).some(e=>e.nodeType===Node.ELEMENT_NODE?!e.classList.contains("currency-converter-overlay"):e.nodeType===Node.TEXT_NODE):"characterData"===e.type&&e.target.textContent)&&$&&f.enabled&&!x&&(clearTimeout(window.currencyConverterDebounce),window.currencyConverterDebounce=setTimeout(()=>{console.log("DOM changed, re-scanning..."),R()},500))});let T;window.addEventListener("scroll",()=>{$&&f.enabled&&!x&&(clearTimeout(T),T=window.setTimeout(()=>{console.log("Scroll detected, checking for new content..."),R()},1e3))},{passive:!0});const F=new IntersectionObserver(e=>{$&&f.enabled&&!x&&e.some(e=>e.isIntersecting)&&(clearTimeout(window.currencyConverterIntersectionDebounce),window.currencyConverterIntersectionDebounce=setTimeout(()=>{console.log("New elements visible, re-scanning..."),R()},500))},{rootMargin:"50px"});function A(){console.log("Currency Converter: Starting up..."),console.log("- Document ready state:",document.readyState),console.log("- URL:",window.location.href),w();const e=window.location.hostname.includes("amazon."),n=window.location.hostname.includes("jd.com"),t=window.location.hostname.includes("taobao.com")||window.location.hostname.includes("tmall.com");if(e||n||t){const t=e?"Amazon":n?"JD":"Taobao";console.log(`üõí ${t} detected, scheduling delayed scans...`),setTimeout(()=>{console.log(`üõí ${t}: First delayed scan (2s)`),$&&f.enabled&&R()},2e3),setTimeout(()=>{console.log(`üõí ${t}: Second delayed scan (5s)`),$&&f.enabled&&R()},5e3)}try{L.observe(document.body,{childList:!0,subtree:!0,characterData:!0}),console.log("DOM observer started")}catch(e){console.error("Failed to start DOM observer:",e)}try{const e=document.querySelectorAll('[class*="price"], [class*="item"], [class*="product"], [class*="goods"]');e.forEach(e=>{F.observe(e)}),console.log(`Intersection observer started, watching ${e.length} containers`)}catch(e){console.error("Failed to start intersection observer:",e)}}"loading"===document.readyState?(console.log("Document still loading, waiting for DOMContentLoaded..."),document.addEventListener("DOMContentLoaded",A)):(console.log("Document already loaded, starting immediately..."),A()),chrome.runtime.onMessage.addListener((e,n,t)=>("EXTENSION_RELOADED"===e.type&&(console.log("Extension reloaded, re-initializing..."),$=!1,C=!1,w(),t({success:!0})),!0)),window.addEventListener("error",e=>{e.message.includes("Extension context invalidated")&&(console.log("Extension context invalidated, resetting state..."),$=!1,C=!1)})})();